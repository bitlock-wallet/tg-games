{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/edine/OneDrive/Documents/BitLock-AI/tg-games/src/app/actions/upsertUserAndScore.ts"],"sourcesContent":["\"use server\";\r\n\r\nexport async function upsertUserAndScoreAction(\r\n  gameId: string,\r\n  userId: string,\r\n  score: number,\r\n  initData?: string | null\r\n) {\r\n  const { pgPool } = await import('../../db/drizzle');\r\n  const client = await pgPool.connect();\r\n  try {\r\n    console.log('[upsertUserAndScore] start', { gameId, userId, score, initData });\r\n    await client.query('BEGIN');\r\n\r\n    // Parse initData (URL query string) server-side to prefer authoritative user info\r\n    // initData format: key=value&... where 'user' may be a JSON-encoded value\r\n    let parsedUsername: string | null = null;\r\n    let parsedDisplayName: string | null = null;\r\n    try {\r\n      if (initData) {\r\n        const pairs = new URLSearchParams(initData);\r\n        const u = pairs.get('user');\r\n        if (u) {\r\n          try {\r\n            const parsed = JSON.parse(decodeURIComponent(u));\r\n            if (parsed) {\r\n              if (parsed.username) parsedUsername = String(parsed.username);\r\n              // prefer first_name as base for display name if username missing\r\n              if (parsed.first_name || parsed.last_name) parsedDisplayName = [parsed.first_name, parsed.last_name].filter(Boolean).join(' ');\r\n              // if username empty but display name available, use that as username as requested\r\n              if (!parsedUsername && parsedDisplayName) parsedUsername = parsedDisplayName;\r\n            }\r\n          } catch (err) {\r\n            // ignore parse errors\r\n            console.warn('[upsertUserAndScore] failed to parse initData user field', err, u);\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      // ignore\r\n    }\r\n\r\n    // Final fallbacks\r\n    const finalUsername = parsedUsername ?? `user-${userId}`;\r\n    const finalDisplayName = parsedDisplayName ?? finalUsername;\r\n    console.log('[upsertUserAndScore] resolved user info', { parsedUsername, parsedDisplayName, finalUsername, finalDisplayName });\r\n\r\n    const UPSERT_USER = `\r\n      INSERT INTO users (id, username, display_name)\r\n      VALUES ($1, $2, $3)\r\n      ON CONFLICT (id) DO UPDATE SET\r\n        username = EXCLUDED.username,\r\n        display_name = EXCLUDED.display_name\r\n      RETURNING id, username, display_name, created_at\r\n    `;\r\n\r\n    const userRes = await client.query(UPSERT_USER, [userId, finalUsername, finalDisplayName]);\r\n    console.log('[upsertUserAndScore] user upsert result rows:', userRes.rows);\r\n\r\n    const UPSERT_SCORE = `\r\n      INSERT INTO game_scores (game_id, user_id, username, score)\r\n      VALUES ($1, $2, $3, $4)\r\n      ON CONFLICT (game_id, user_id)\r\n      DO UPDATE SET score = GREATEST(game_scores.score, EXCLUDED.score), username = EXCLUDED.username, recorded_at = CURRENT_TIMESTAMP\r\n      RETURNING game_id, user_id, username, score\r\n    `;\r\n\r\n    const scoreRes = await client.query(UPSERT_SCORE, [gameId, userId, finalUsername, score]);\r\n    console.log('[upsertUserAndScore] score upsert result rows:', scoreRes.rows);\r\n\r\n    await client.query('COMMIT');\r\n\r\n    return {\r\n      user: userRes.rows && userRes.rows[0] ? userRes.rows[0] : null,\r\n      score: scoreRes.rows && scoreRes.rows[0] ? scoreRes.rows[0] : null,\r\n    };\r\n  } catch (e) {\r\n    try {\r\n      await client.query('ROLLBACK');\r\n    } catch (_) {\r\n      // ignore\r\n    }\r\n    throw e;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;AAEO,eAAe,yBACpB,MAAc,EACd,MAAc,EACd,KAAa,EACb,QAAwB;IAExB,MAAM,EAAE,MAAM,EAAE,GAAG;IACnB,MAAM,SAAS,MAAM,OAAO,OAAO;IACnC,IAAI;QACF,QAAQ,GAAG,CAAC,8BAA8B;YAAE;YAAQ;YAAQ;YAAO;QAAS;QAC5E,MAAM,OAAO,KAAK,CAAC;QAEnB,kFAAkF;QAClF,0EAA0E;QAC1E,IAAI,iBAAgC;QACpC,IAAI,oBAAmC;QACvC,IAAI;YACF,IAAI,UAAU;gBACZ,MAAM,QAAQ,IAAI,gBAAgB;gBAClC,MAAM,IAAI,MAAM,GAAG,CAAC;gBACpB,IAAI,GAAG;oBACL,IAAI;wBACF,MAAM,SAAS,KAAK,KAAK,CAAC,mBAAmB;wBAC7C,IAAI,QAAQ;4BACV,IAAI,OAAO,QAAQ,EAAE,iBAAiB,OAAO,OAAO,QAAQ;4BAC5D,iEAAiE;4BACjE,IAAI,OAAO,UAAU,IAAI,OAAO,SAAS,EAAE,oBAAoB;gCAAC,OAAO,UAAU;gCAAE,OAAO,SAAS;6BAAC,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC;4BAC1H,kFAAkF;4BAClF,IAAI,CAAC,kBAAkB,mBAAmB,iBAAiB;wBAC7D;oBACF,EAAE,OAAO,KAAK;wBACZ,sBAAsB;wBACtB,QAAQ,IAAI,CAAC,4DAA4D,KAAK;oBAChF;gBACF;YACF;QACF,EAAE,OAAO,GAAG;QACV,SAAS;QACX;QAEA,kBAAkB;QAClB,MAAM,gBAAgB,kBAAkB,CAAC,KAAK,EAAE,QAAQ;QACxD,MAAM,mBAAmB,qBAAqB;QAC9C,QAAQ,GAAG,CAAC,2CAA2C;YAAE;YAAgB;YAAmB;YAAe;QAAiB;QAE5H,MAAM,cAAc,CAAC;;;;;;;IAOrB,CAAC;QAED,MAAM,UAAU,MAAM,OAAO,KAAK,CAAC,aAAa;YAAC;YAAQ;YAAe;SAAiB;QACzF,QAAQ,GAAG,CAAC,iDAAiD,QAAQ,IAAI;QAEzE,MAAM,eAAe,CAAC;;;;;;IAMtB,CAAC;QAED,MAAM,WAAW,MAAM,OAAO,KAAK,CAAC,cAAc;YAAC;YAAQ;YAAQ;YAAe;SAAM;QACxF,QAAQ,GAAG,CAAC,kDAAkD,SAAS,IAAI;QAE3E,MAAM,OAAO,KAAK,CAAC;QAEnB,OAAO;YACL,MAAM,QAAQ,IAAI,IAAI,QAAQ,IAAI,CAAC,EAAE,GAAG,QAAQ,IAAI,CAAC,EAAE,GAAG;YAC1D,OAAO,SAAS,IAAI,IAAI,SAAS,IAAI,CAAC,EAAE,GAAG,SAAS,IAAI,CAAC,EAAE,GAAG;QAChE;IACF,EAAE,OAAO,GAAG;QACV,IAAI;YACF,MAAM,OAAO,KAAK,CAAC;QACrB,EAAE,OAAO,GAAG;QACV,SAAS;QACX;QACA,MAAM;IACR,SAAU;QACR,OAAO,OAAO;IAChB;AACF;;;IApFsB;;AAAA,8VAAA","debugId":null}},
    {"offset": {"line": 114, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/edine/OneDrive/Documents/BitLock-AI/tg-games/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {upsertUserAndScoreAction as '78c5852c71554d8806ed936f92da38cccff9b48395'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/edine/OneDrive/Documents/BitLock-AI/tg-games/node_modules/.pnpm/next%4016.0.1_%40babel%2Bcore%407.2_048eab391ea2e03c70ee64ac0670005b/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n"],"names":["registerServerReference"],"mappings":"AAAA,oDAAoD;;;+BAC3CA,2BAAAA;;;eAAAA,QAAAA,uBAAuB;;;wBAAQ","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 145, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/edine/OneDrive/Documents/BitLock-AI/tg-games/node_modules/.pnpm/next%4016.0.1_%40babel%2Bcore%407.2_048eab391ea2e03c70ee64ac0670005b/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts"],"sourcesContent":["// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n"],"names":["ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"AAAA,+EAA+E;AAC/E,yEAAyE;AACzE,iEAAiE;;;;+BACjDA,4BAAAA;;;eAAAA;;;AAAT,SAASA,yBAAyBC,OAAc;IACrD,IAAK,IAAIC,IAAI,GAAGA,IAAID,QAAQE,MAAM,EAAED,IAAK;QACvC,MAAME,SAASH,OAAO,CAACC,EAAE;QACzB,IAAI,OAAOE,WAAW,YAAY;YAChC,MAAM,OAAA,cAEL,CAFK,IAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,OAAO,uEAAuE,CAAC,GADhJ,qBAAA;uBAAA;4BAAA;8BAAA;YAEN;QACF;IACF;AACF","ignoreList":[0],"debugId":null}}]
}